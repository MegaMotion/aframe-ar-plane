<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Hello, World! • A-Frame three.ar.js</title>
    <meta name="description" content="Hello, World! • A-Frame three.ar.js">
    <script src="https://aframe.io/releases/0.6.1/aframe.min.js"></script>
    <script src="https://rawgit.com/google-ar/three.ar.js/master/dist/three.ar.js"></script>
    <script src="https://rawgit.com/chenzlabs/aframe-ar/master/dist/aframe-ar.js"></script>
  </head>
  <body>    
    <script>
      AFRAME.registerComponent('thing', {
        init: function () {
          this.el.setAttribute('geometry', {primitive:'box', width:0.01, depth:0.01, height:1});
          this.el.setAttribute('position', {y:0.5});
        }
      });            
    </script>
    
    <a-scene ar>
      <!-- When we have a raycaster hit, we use this ball to show where. -->
      <a-sphere id="ball" radius="0.01" position="0 0.005 -0.5"></a-sphere>
        
      <a-camera>
        <!-- A hit from AR, rather than A-Frame objects, hits this entity. -->
        <a-entity id="ar-world"></a-entity>
        
        <!-- Declare a cursor, and what objects its raycaster hit (including AR). -->
        <a-cursor raycaster="objects:.plane; near:0.01" 
                  ar-raycaster="el:#ar-world"></a-cursor>

        <!-- Heads-up text display. -->
        <a-text id="hud" 
                scale="0.01 0.01 0.01" position="0 -0.025 -0.1" 
                color="yellow" align="center" 
                value="Hi there"></a-text>
      </a-camera>
    </a-scene>    
    
    <script>
      var sc = document.querySelector('a-scene');
      function showHUD(msg) { sc.querySelector('#hud').setAttribute('value', msg); }
      
      function onCreateOrUpdatePlane(evt) {
        var plane = sc.querySelector('#plane_' + evt.detail.id);
        if (!plane) {
          // Create and append the plane.
          plane = document.createElement('a-box');
          plane.setAttribute('id', 'plane_' + evt.detail.id);
          plane.setAttribute('class', 'plane');
          plane.setAttribute('color', 'red');
          plane.setAttribute('opacity', 0.2);
          plane.setAttribute('height', 0.001);
          sc.appendChild(plane);
          
          plane.insertAdjacentHTML('beforeend',
            // Add a plane label (which needs to be rotated to match a-box).
            '<a-entity class="label" rotation="-90 0 0"></a-entity>' +
            // Add a thing to mark the center of the plane.
            '<a-entity thing></a-entity>');
        }
        
        // Update the plane.
        plane.setAttribute('width', evt.detail.extent.x);
        plane.setAttribute('depth', evt.detail.extent.z);
        plane.setAttribute('position', evt.detail.position);
        plane.setAttribute('rotation', evt.detail.rotation);
        // Currently, scale is always 1... 
        // plane.setAttribute('scale', evt.detail.scale);
        
        // Fill out the plane label with informative text. 
        plane.querySelector('.label').setAttribute('text', {
         width: plane.getAttribute('width'), 
         height: plane.getAttribute('depth'), 
         align: 'left',
         zOffset: 0.01,
         wrapCount: 100, value: 
          'id: ' + plane.getAttribute('id')
        + '\nwidth: ' + plane.getAttribute('width')
        + '\ndepth: ' + plane.getAttribute('depth')
        + '\nposition x: ' + plane.getAttribute('position').x
        + '\nposition y: ' + plane.getAttribute('position').y
        + '\nposition z: ' + plane.getAttribute('position').z
        + '\nrotation x: ' + plane.getAttribute('rotation').x
        + '\nrotation y: ' + plane.getAttribute('rotation').y
        + '\nrotation z: ' + plane.getAttribute('rotation').z
        // Currently, scale is always 1... 
        //+ '\nscale x: ' + plane.getAttribute('scale').x
        //+ '\nscale y: ' + plane.getAttribute('scale').y
        //+ '\nscale z: ' + plane.getAttribute('scale').z
        });
        
        // We updated the plane (or added it), so update the raycaster.
        // Because there may be a DOM change, we need to wait a tick.
        // FIXME: sometimes displayed planes do not match raycaster results?
        setTimeout(function () {
          sc.querySelector('[raycaster]').components.raycaster.refreshObjects();
        });
        return plane;
      }      
      
      function onRemovePlane(evt) {
        var plane = sc.querySelector('#plane_' + evt.detail.id);
        if (plane && plane.parentElement) {
          plane.parentElement.removeChild(plane);
        }
      }      
      
      function addPlaneListeners() {
        sc.addEventListener('createplane', onCreateOrUpdatePlane);
        sc.addEventListener('updateplane', onCreateOrUpdatePlane);
        sc.addEventListener('removeplane', onRemovePlane);                
      }
      
      function addARRaycasterListeners() {
        var raycaster = sc.querySelector('[ar-raycaster]');
        // Note, -intersection is what the raycaster gets; the hit object gets -intersected.
        raycaster.addEventListener('raycaster-intersection', function (evt) {
          var point = evt.detail.intersections[0].point;
          var el = evt.detail.els[0];
          showHUD('raycaster-intersection\n' + JSON.stringify(point) + '\n' + el.outerHTML);
          if (el.getAttribute('class') === 'plane') { el.setAttribute('opacity', 0.5); }
          ball.setAttribute('position', point);
          ball.setAttribute('visible', true);
        });
        raycaster.addEventListener('raycaster-intersection-cleared', function (evt) {
          var el = evt.detail.el;
          showHUD('raycaster-intersection-cleared\n' + el.outerHTML);
          if (el.getAttribute('class') === 'plane') { el.setAttribute('opacity', 0.2); }
          ball.setAttribute('visible', false);
        });
      }
      
      function addEventListeners() {
        addARRaycasterListeners();
        addPlaneListeners();
      }
      
      function onSceneLoaded() { 
        var threear = AFRAME.scenes[0].components['three-ar'];
        if (!threear) { showHUD('no threear?'); } else {
          showHUD(Object.keys(threear.arDisplay).join(','));
        }

        addEventListeners(); 
      }
      
      if (sc.hasLoaded) { onSceneLoaded(); }
      else { sc.addEventListener('loaded', onSceneLoaded); }
    </script>
  </body>
</html>